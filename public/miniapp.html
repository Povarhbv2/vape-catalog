<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  background:#0a0a12;
  font-family:Arial;
  color:white;
}

.title{
  text-align:center;
  color:#c86bff;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  padding:10px;
}

.card{
  background:#141420;
  padding:10px;
  border-radius:12px;
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:10px;
}

button{
  background:#a100ff;
  color:white;
  border:none;
  padding:10px;
  width:100%;
  border-radius:10px;
  margin-top:5px;
}

.modal{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  overflow:auto;
  padding:15px;
}

input{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:8px;
  border:none;
}
</style>

<title>VapeStock PRO</title>
</head>

<body>

<h2 class="title">üí® VapeStock</h2>

<div id="products" class="grid"></div>

<button onclick="openCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞</button>

<div id="modal" class="modal"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyDJxLWeTxVeH2r64rv9rCLUW4RtM1A6zXI",
 authDomain:"vapestock-3dc76.firebaseapp.com",
 projectId:"vapestock-3dc76"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const tg=window.Telegram?.WebApp;
if(tg) tg.expand();

let CART=[];
let ALL=[];

const prodDiv=document.getElementById("products");
const modal=document.getElementById("modal");

async function load(){
 const snap=await getDocs(collection(db,"products"));
 snap.forEach(d=>{
   const p=d.data();
   ALL.push(p);

   const div=document.createElement("div");
   div.className="card";
   div.innerHTML=`
     <img src="${p.image}">
     <h4>${p.name}</h4>
     <p>${p.price}</p>
     <button onclick='add(${JSON.stringify(p)})'>–í –∫–æ—Ä–∑–∏–Ω—É</button>
   `;
   prodDiv.appendChild(div);
 });
}

window.add=p=>{
 CART.push(p);
 alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
}

window.openCart=()=>{
 modal.style.display="block";

 let html="<h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>";
 let total=0;

 CART.forEach(p=>{
   html+=`<p>${p.name} ‚Äî ${p.price}</p>`;
   total+=Number(p.price.replace(/\D/g,''));
 });

 html+=`
   <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
   <input id="fio" placeholder="–§–ò–û">
   <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
   <input id="email" placeholder="Email">
   <button onclick="checkout()">–ó–∞–∫–∞–∑–∞—Ç—å</button>
 `;

 modal.innerHTML=html;
}

window.checkout=()=>{
 const orderId=Date.now()+"-0001";

 const fio=document.getElementById("fio").value;
 const phone=document.getElementById("phone").value;
 const email=document.getElementById("email").value;

 let items="";
 let sum=0;

 CART.forEach(p=>{
   items+=`${p.name} ${p.price} x1\n`;
   sum+=Number(p.price.replace(/\D/g,''));
 });

 const buyerMsg=
`–ó–∞–∫–∞–∑ ‚Ññ${orderId} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω

–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏
–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${fio} (${tg?.initDataUnsafe?.user?.username ? "https://telegram.me/"+tg.initDataUnsafe.user.username : ""})
–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${phone}
Email: ${email}
–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏: –°–∞–º–æ–≤—ã–≤–æ–∑

–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
${items}

–°—É–º–º–∞: ${sum} ‚ÇΩ

–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!`;

 const sellerMsg=
`–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –±–µ–∑ –æ–ø–ª–∞—Ç—ã ‚Ññ${orderId}

–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏
–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${fio}
–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}
Email: ${email}

–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
${items}

–°—É–º–º–∞: ${sum} ‚ÇΩ`;

 if(tg){
   tg.sendData(JSON.stringify({
     orderId,
     buyerMsg,
     sellerMsg
   }));
 }

 alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
 CART=[];
 modal.style.display="none";
}

load();

</script>
</body>
</html>
