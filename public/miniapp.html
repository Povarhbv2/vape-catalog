<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  background:#0a0a12;
  font-family:Arial;
  color:white;
}

.title{
  text-align:center;
  color:#c86bff;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  padding:10px;
}

.card{
  background:#141420;
  padding:10px;
  border-radius:12px;
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:10px;
}

button{
  background:#a100ff;
  color:white;
  border:none;
  padding:10px;
  width:100%;
  border-radius:10px;
  margin-top:5px;
}

.modal{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  padding:15px;
}
</style>

<title>VapeStock</title>
</head>

<body>

<h2 class="title">üí® VapeStock</h2>

<div id="products" class="grid"></div>

<button onclick="openCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞</button>

<div id="modal" class="modal"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyDJxLWeTxVeH2r64rv9rCLUW4RtM1A6zXI",
 authDomain:"vapestock-3dc76.firebaseapp.com",
 projectId:"vapestock-3dc76"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const tg=window.Telegram.WebApp;
tg.expand();

let CART=[];
const prodDiv=document.getElementById("products");
const modal=document.getElementById("modal");

async function load(){
 prodDiv.innerHTML="";
 const snap=await getDocs(collection(db,"products"));

 snap.forEach(d=>{
   const p=d.data();

   const div=document.createElement("div");
   div.className="card";

   div.innerHTML=`
     <img src="${p.image}">
     <h4>${p.name}</h4>
     <p>${p.price}</p>
     <button onclick='add(${JSON.stringify(p)})'>–í –∫–æ—Ä–∑–∏–Ω—É</button>
   `;

   prodDiv.appendChild(div);
 });
}

window.add=p=>{
 CART.push(p);
 alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
}

window.openCart=()=>{
 modal.style.display="block";

 let html="<h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>";
 let sum=0;

 CART.forEach(p=>{
   html+=`<p>${p.name} ‚Äî ${p.price}</p>`;
   sum+=Number(p.price.replace(/\D/g,''));
 });

 html+=`
 <input id="fio" placeholder="–§–ò–û">
 <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
 <button onclick="checkout()">–ó–∞–∫–∞–∑–∞—Ç—å</button>
 `;

 modal.innerHTML=html;
}

window.checkout=()=>{
 if(CART.length===0){
   alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
   return;
 }

 let items="";
 let sum=0;

 CART.forEach(p=>{
   items+=`${p.name} ${p.price}\n`;
   sum+=Number(p.price.replace(/\D/g,''));
 });

 tg.sendData(JSON.stringify({
   buyerMsg:`–ó–∞–∫–∞–∑ –Ω–∞ ${sum} ‚ÇΩ –ø—Ä–∏–Ω—è—Ç!`,
   sellerMsg:`–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n${items}\n–°—É–º–º–∞: ${sum} ‚ÇΩ`
 }));

 tg.close();
}

load();

</script>
</body>
</html>
