<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  background:#0a0a12;
  font-family:Arial;
  color:white;
}

.title{
  text-align:center;
  color:#c86bff;
  text-shadow:0 0 15px #a100ff;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  padding:12px;
}

.card{
  background:#141420;
  border-radius:16px;
  padding:12px;
  border:1px solid #6a00ff;
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:10px;
}

button{
  background:#a100ff;
  border:none;
  color:white;
  padding:10px;
  border-radius:10px;
  width:100%;
  margin-top:8px;
}

.cartBtn{
  position:fixed;
  bottom:15px;
  right:15px;
  width:60px;
  height:60px;
  border-radius:50%;
  font-size:20px;
}

.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#000;
  display:none;
  overflow:auto;
  padding:10px;
}

input{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:8px;
  border:none;
}
</style>

<title>VapeStock</title>
</head>

<body>

<h2 class="title">üí® VapeStock</h2>

<div id="categories" class="grid"></div>
<div id="products" class="grid"></div>

<button class="cartBtn" onclick="openCart()">üõí</button>
<button onclick="openAdmin()">ADMIN</button>

<div id="modal" class="modal"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDJxLWeTxVeH2r64rv9rCLUW4RtM1A6zXI",
  authDomain:"vapestock-3dc76.firebaseapp.com",
  projectId:"vapestock-3dc76"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tg = window.Telegram?.WebApp;
if(tg) tg.expand();

let CART=[];
let ALL=[];

const catDiv=document.getElementById("categories");
const prodDiv=document.getElementById("products");
const modal=document.getElementById("modal");

async function load(){
  const snap=await getDocs(collection(db,"products"));
  ALL=[];
  snap.forEach(d=>ALL.push(d.data()));

  showCategories();
}

function showCategories(){
  catDiv.innerHTML="";
  const cats=[...new Set(ALL.map(p=>p.category))];

  cats.forEach(c=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`<h3>${c}</h3>`;
    d.onclick=()=>showProducts(c);
    catDiv.appendChild(d);
  });
}

function showProducts(cat){
  prodDiv.innerHTML="";
  ALL.filter(p=>p.category==cat).forEach(p=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <img src="${p.image}">
      <h4>${p.name}</h4>
      <p>${p.price}</p>
      <button onclick='event.stopPropagation();addCart(${JSON.stringify(p)})'>–í –∫–æ—Ä–∑–∏–Ω—É</button>
    `;
    d.onclick=()=>openProduct(p);
    prodDiv.appendChild(d);
  });
}

window.openProduct=p=>{
  modal.style.display="block";
  modal.innerHTML=`
    <button onclick="closeModal()">–ù–∞–∑–∞–¥</button>
    <img src="${p.image}" style="width:100%">
    <h2>${p.name}</h2>
    <h3>${p.price}</h3>
    <button onclick='addCart(${JSON.stringify(p)})'>–í –∫–æ—Ä–∑–∏–Ω—É</button>
  `;
}

window.closeModal=()=>modal.style.display="none";

window.addCart=p=>{
  CART.push(p);
  alert("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
}

window.openCart=()=>{
  modal.style.display="block";
  let html="<h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>";
  CART.forEach(p=>html+=`<p>${p.name} ‚Äî ${p.price}</p>`);
  html+=`<button onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>`;
  modal.innerHTML=html;
}

window.checkout=()=>{
  if(tg){
    tg.sendData(JSON.stringify(CART));
  }
  alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
  CART=[];
  closeModal();
}

window.openAdmin=()=>{
  modal.style.display="block";
  modal.innerHTML=`
    <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
    <input id="n" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input id="p" placeholder="–¶–µ–Ω–∞">
    <input id="i" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
    <input id="c" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
    <button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  `;
}

window.save=async()=>{
  await addDoc(collection(db,"products"),{
    name:n.value,
    price:p.value,
    image:i.value,
    category:c.value,
    stock:10
  });
  alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
  closeModal();
  load();
}

load();

</script>
</body>
</html>
